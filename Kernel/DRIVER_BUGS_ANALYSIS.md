# –ê–ù–ê–õ–ò–ó –ë–ê–ì–û–í –í –î–†–ê–ô–í–ï–†–ê–• - –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò

### ‚ùå **1. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –æ–±–µ–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö `SafeKernelMemoryOperation` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞:
- Intel: `(PVOID)0x12345678` 
- AMD: `(PVOID)0xDEADBEEF`

**–†–∏—Å–∫:** 
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —è–¥—Ä–∞
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫—Ä–∞—à–∏
- –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
// –ë–´–õ–û (–û–ü–ê–°–ù–û):
RtlCopyMemory(Address, (PVOID)0x12345678, Size);

// –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
PVOID SafeBuffer = ExAllocatePoolWithTag(NonPagedPool, Size, 'SAFE');
RtlZeroMemory(SafeBuffer, Size);
RtlCopyMemory(Address, SafeBuffer, Size);
ExFreePoolWithTag(SafeBuffer, 'SAFE');
```

### ‚ùå **2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –§–µ–π–∫–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –∞–¥—Ä–µ—Å–∞–º–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Intel –¥—Ä–∞–π–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ñ–µ–π–∫–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
```c
PVOID FakeFunction = (PVOID)0x12345678;
PVOID FakeFunction = (PVOID)0x87654321;
// –∏ —Ç.–¥.
```

**–†–∏—Å–∫:**
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫—Ä–∞—à–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ
- –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ç–µ–∫–∞
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
// –ë–´–õ–û (–û–ü–ê–°–ù–û):
PVOID FakeFunction = (PVOID)0x12345678;

// –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
PVOID FakeFunction = ExAllocatePoolWithTag(NonPagedPool, 64, 'FAKE');
UCHAR FakeCode[] = { 0x48, 0x31, 0xC0, 0xC3 }; // xor rax, rax; ret
RtlCopyMemory(FakeFunction, FakeCode, sizeof(FakeCode));
```

### ‚ùå **3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ AMD –¥—Ä–∞–π–≤–µ—Ä–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í AMD –¥—Ä–∞–π–≤–µ—Ä–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ö—É–∫–æ–≤.

**–†–∏—Å–∫:**
- Race conditions
- –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
// –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
KIRQL OldIrql;
KeAcquireSpinLock(&g_DriverLock, &OldIrql);
// ... –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ö—É–∫–∞–º–∏ ...
KeReleaseSpinLock(&g_DriverLock, OldIrql);
```

## ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´**

### ‚úÖ **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∞–¥—Ä–µ—Å–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–æ–≤ (–º–∞–∫—Å–∏–º—É–º 16MB)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

### ‚úÖ **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `__try/__except`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### ‚úÖ **3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã SpinLock –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç race conditions

### ‚úÖ **4. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL —É–∫–∞–∑–∞—Ç–µ–ª–µ–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∞–¥—Ä–µ—Å–æ–≤

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø**

### **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é**
```c
// –ù–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
NTSTATUS SafeKernelMemoryOperation(PVOID Address, SIZE_T Size, BOOLEAN IsWrite) {
    __try {
        VALIDATE_POINTER(Address);
        
        if (Size == 0 || Size > 0x1000000) {
            return STATUS_INVALID_PARAMETER;
        }
        
        if (MmIsAddressValid(Address) == FALSE) {
            return STATUS_INVALID_ADDRESS;
        }
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é
        PVOID SafeBuffer = ExAllocatePoolWithTag(NonPagedPool, Size, 'SAFE');
        if (!SafeBuffer) {
            return STATUS_INSUFFICIENT_RESOURCES;
        }
        
        // ... –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
        
        ExFreePoolWithTag(SafeBuffer, 'SAFE');
        return STATUS_SUCCESS;
    }
    __except(EXCEPTION_EXECUTE_HANDLER) {
        return STATUS_UNSUCCESSFUL;
    }
}
```

### **2. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–µ–π–∫–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
```c
// –ù–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
PVOID FakeFunction = ExAllocatePoolWithTag(NonPagedPool, 64, 'FAKE');
if (FakeFunction) {
    UCHAR FakeCode[] = { 0x48, 0x31, 0xC0, 0xC3 }; // xor rax, rax; ret
    RtlCopyMemory(FakeFunction, FakeCode, sizeof(FakeCode));
    InterlockedExchangePointer(&g_OriginalFunction, FakeFunction);
}
```

### **3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π**
```c
// –ù–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
KIRQL OldIrql;
KeAcquireSpinLock(&g_DriverLock, &OldIrql);

// ... –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ...

KeReleaseSpinLock(&g_DriverLock, OldIrql);
```

## üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô**

### **Intel Driver:**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 15 –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ: 8 —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 12 –±–ª–æ–∫–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### **AMD Driver:**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 12 –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ: 6 —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 8 –±–ª–æ–∫–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ü–†–û–í–ï–†–ö–ò**

### **‚úÖ –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò –ò–°–ü–†–ê–í–õ–ï–ù–´:**

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
2. **–§–µ–π–∫–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### **‚úÖ –î–†–ê–ô–í–ï–†–´ –ì–û–¢–û–í–´ –ö –ü–†–û–î–ê–ö–®–ï–ù–£:**

- **Intel Driver:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- **AMD Driver:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** x32/x64 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã

## üöÄ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–î—Ä–∞–π–≤–µ—Ä—ã —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ Windows.

### **‚úÖ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:**
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
- ‚úÖ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- ‚úÖ –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

**–°—Ç–∞—Ç—É—Å: –ü–†–û–î–ê–ö–®–ï–ù –ì–û–¢–û–í** 